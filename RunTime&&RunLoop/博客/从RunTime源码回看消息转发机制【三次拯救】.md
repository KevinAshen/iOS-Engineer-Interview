[TOC]
# å…³äºæˆ‘çš„ä»“åº“

- è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ä¸ºé¢è¯•å‡†å¤‡çš„iOSåŸºç¡€çŸ¥è¯†å­¦ä¹ ä¸­çš„ä¸€ç¯‡
- æˆ‘å°†å‡†å¤‡é¢è¯•ä¸­æ‰¾åˆ°çš„æ‰€æœ‰å­¦ä¹ èµ„æ–™ï¼Œå†™çš„Demoï¼Œå†™çš„åšå®¢éƒ½æ”¾åœ¨äº†è¿™ä¸ªä»“åº“é‡Œ[iOS-Engineer-Interview](https://github.com/KevinAshen/iOS-Engineer-Interview)
- æ¬¢è¿starğŸ‘ğŸ‘
- å…¶ä¸­çš„åšå®¢åœ¨ç®€ä¹¦ï¼ŒCSDNéƒ½æœ‰å‘å¸ƒ
- åšå®¢ä¸­æåˆ°çš„ç›¸å…³çš„ä»£ç Demoå¯ä»¥åœ¨ä»“åº“é‡Œç›¸åº”çš„æ–‡ä»¶å¤¹é‡Œæ‰¾åˆ°

# å‰è¨€

- æœ¬æ–‡ä¸»è¦æ¶‰åŠæ¶ˆæ¯è½¬å‘çš„ä¸‰ä¸ªæ–¹æ³•çš„ä½¿ç”¨æ–¹å¼ï¼Œé€šè¿‡æ‰“å°è¯•éªŒéªŒè¯æ¶ˆæ¯æŸ¥æ‰¾é“¾é—®é¢˜
- ç¿»è¯‘äº†éƒ¨åˆ†Appleæ–‡æ¡£ï¼Œä»¥è¯´æ˜æ–¹æ³•ç­¾åçš„ä½œç”¨
- å¯¹æ¶ˆæ¯è½¬å‘çš„æ„ä¹‰åšäº†æ¢è®¨

# å‡†å¤‡å·¥ä½œ

- è¯·å‡†å¤‡å¥½750.1ç‰ˆæœ¬çš„objc4æºç ä¸€ä»½ã€ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬ã€‘ï¼Œæ‰“å¼€å®ƒï¼Œæ‰¾åˆ°æ–‡ç« ä¸­æåˆ°çš„æ–¹æ³•ï¼Œç±»å‹ï¼Œå¯¹è±¡
- ä¸€åˆ‡è¯·ä»¥æ‰‹ä¸­æºç ä¸ºå‡†ï¼Œä¸è¦è½»ä¿¡ä»»ä½•äººï¼Œä»»ä½•æ–‡ç« ï¼ŒåŒ…æ‹¬æœ¬ç¯‡åšå®¢
- æ–‡ç« ä¸­çš„æºç éƒ½è¯·è¿‡äº†æˆ‘çš„åˆ æ”¹ï¼Œå»ºè®®è¿˜æ˜¯å…ˆçœ‹çœ‹æºç 
- æºç å»ºè®®ä»Appleå®˜æ–¹å¼€æºç½‘ç«™è·å–[obj4](https://opensource.apple.com/tarballs/objc4/objc4-750.1.tar.gz)
- å®˜ç½‘ä¸Šä¸‹è½½ä¸‹æ¥éœ€è¦è‡ªå·±é…ç½®æ‰èƒ½ç¼–è¯‘è¿è¡Œï¼Œå¦‚æœä¸æƒ³é…ç½®ï¼Œå¯ä»¥åœ¨[RuntimeSourceCode](https://github.com/acBool/RuntimeSourceCode)ä¸­clone

# ä¸€ä¸ªè¯´æ³•

- æˆ‘ä»¬å…ˆå¯ä»¥å¯¹æ¶ˆæ¯è½¬å‘æ¥ä¸ªæ¦‚è¿°ï¼šå½“å¯¹è±¡è°ƒç”¨äº†ä¸€ä¸ªå®ƒæ²¡æœ‰çš„æ–¹æ³•æ—¶ã€çˆ¶ç±»ä¹Ÿæ‰¾ä¸åˆ°å®ç°ã€‘ï¼Œä¼šå‡ºç°crashï¼›æ¶ˆæ¯è½¬å‘ç®€å•æ¥è¯´å°±æ˜¯å¤„ç†è°ƒç”¨å¯¹è±¡æ²¡æœ‰çš„æ–¹æ³•æ—¶çš„å¤„ç†ã€è¿™é‡Œçš„å¯¹è±¡ä¹ŸæŒ‡ç±»å¯¹è±¡ã€‘
- å› æ­¤ï¼Œæ¶ˆæ¯è½¬å‘å¸¸å¸¸è¢«äººç§°ä¸ºé˜²æ­¢ç¨‹åºcrashçš„æªæ–½
- æ–‡ç« æœ€åä¼šæ¢è®¨è¿™ç§è¯´æ³•æ˜¯å¦æ­£ç¡®

# å…³äºæ¶ˆæ¯è½¬å‘

- æˆ‘ä»¬å·²ç»å­¦ä¹ åˆ°ï¼ŒOCçš„åº•å±‚éƒ½æ˜¯C++å®ç°çš„ï¼Œè€Œæ–¹æ³•çš„è°ƒç”¨ï¼Œå®é™…ä¸Šæ˜¯æ¶ˆæ¯çš„å‘é€
- æ¯”å¦‚å¯¹è±¡Aè°ƒç”¨æ–¹æ³•Bï¼Œæˆ‘ä»¬å°±ä¼šæŸ¥æ‰¾Aä¸­çš„æ–¹æ³•åˆ—è¡¨ï¼Œå¯»æ‰¾æ–¹æ³•Bå¯¹åº”çš„å‡½æ•°æ‰§è¡Œ
- è¿™é‡Œç”¨åˆ°çš„å°±æ˜¯objc_msgSend
- è€Œæ¶ˆæ¯è½¬å‘æ´¾ä¸Šç”¨åœºçš„æƒ…å†µï¼Œå°±æ˜¯åœ¨æŠŠå½“å‰ç±»ï¼Œçˆ¶ç±»ï¼Œä¹ƒè‡³åˆ°æ ¹ç±»å…¨éƒ½æ‰¾å®Œäº†ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°æ–¹æ³•Bæ—¶è¿›è¡Œçš„æªæ–½

## ä¸‰é“é˜²çº¿

- Appleç»™æ¶ˆæ¯è½¬å‘æä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œä¸‰ä¸ªéƒ½å¯ä»¥å®ç°ä¸Šé¢è¯´çš„è¿™ä»¶äº‹
- åˆ†åˆ«æ˜¯åŠ¨æ€æ–¹æ³•è§£æï¼Œå¤‡ç”¨æ¥æ”¶è€…ï¼Œå®Œæ•´è½¬å‘
- å¹¶ä¸”è¿™ä¸‰ä¸ªæ–¹æ³•çš„å…³ç³»æ˜¯é€’è¿›çš„ï¼Œå¹¶ä¸”è¿™ä¸‰ä¸ªæ–¹æ³•æ˜¯é€’è¿›çš„ï¼Œå‰ä¸€ä¸ªå®ç°äº†å°±ä¸ä¼šèµ°åä¸€ä¸ªï¼ŒåŒæ—¶è¶Šå¾€åå¤„ç†çš„ä»£ä»·è¶Šå¤§

## å…³ç³»å›¾

![E81306B3-FD5F-4B68-B7DF-7FA084A20E62](http://ww1.sinaimg.cn/large/006tNc79ly1g5ho2v126rj30gl093t95.jpg)

- ä¸‹é¢å¼€å§‹è¯¦è§£è¿™ä¸‰ä¸ªæ–¹æ³•

# åŠ¨æ€æ–¹æ³•è§£æã€resolveInstanceMethodã€‘

## ä½œç”¨
- å½“å‘ç°selåœ¨classé‡Œçš„æ–¹æ³•åˆ—è¡¨é‡Œå¯¹ä¸ä¸Šå·çš„æ—¶å€™ï¼Œä¼šç»™ç±»çš„æ–¹æ³•åˆ—è¡¨æ·»åŠ è¯¥æ–¹æ³•
- éœ€è¦è‡ªå·±å®ç°æ–¹æ³•å¯¹åº”çš„imp

## runtimeæºç 

```objective-c
+ (BOOL)resolveInstanceMethod:(SEL)sel {
    return NO;
}
```

- ä¸é‡å†™çš„è¯ï¼Œé»˜è®¤è¿”å›NOï¼Œä¸èµ°è¯¥æ–¹æ³•

## å®é™…ä½¿ç”¨

- è¿™é‡Œè™½ç„¶æˆ‘ä»¬è¦è¯•éªŒæ¶ˆæ¯è½¬å‘ï¼Œä½†å¦‚æœä½ ç›´æ¥è®©ä¸€ä¸ªå¯¹è±¡å»è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œç¼–è¯‘å™¨è‚¯å®šä¼šç»™ä½ æŠ¥é”™ï¼Œä¸è®©ä½ ç¼–è¯‘çš„
- å› æ­¤ä¸ºäº†è¯•éªŒï¼Œè°ƒç”¨æ–¹æ³•ä¼šåœ¨.hé‡Œé¢å†™ç”³æ˜ï¼Œä½†æ˜¯ä¸ä¼šå†™å®ç°ï¼Œå…ˆéª—è¿‡ç¼–è¯‘å™¨å†è¯´
- ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªè½¬å‘ï¼Œå®é™…ä¸Šè¿˜æ˜¯å› ä¸ºOCæ˜¯åŠ¨æ€è¯­è¨€ï¼Œæ–¹æ³•çœŸæ­£çš„è°ƒç”¨è¦åˆ°è¿è¡Œæ—¶æ‰ä¼šæŸ¥æ‰¾
- å…ˆå°è¯•ç›´æ¥è¿”å›YESï¼Œä¸åšä»»ä½•å¤„ç†ä¼šå‘ç”Ÿä»€ä¹ˆ

### ç›´æ¥è¿”å›YES
```objective-c
///Person.m
#import "Person.h"
@implementation Person
+ (BOOL)resolveInstanceMethod:(SEL)sel {
    return YES;
}
@end

///main.m
#import <Foundation/Foundation.h>
#import "Student.h"
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        NSLog(@"Hello, World!");
        Student *student = [[Student alloc] init];
        [student eat:@"123"];
    }
    return 0;
}

//-[Person eat:]: unrecognized selector sent to instance 0x100700160
```
- ç»“æœä¾ç„¶crashï¼Œæ‰¾ä¸åˆ°è¯¥selå¯¹åº”çš„imp

### æ­£å¸¸è°ƒç”¨
```objective-c
///Person.m
#import "Person.h"
#import <objc/runtime.h>
@implementation Person
+ (BOOL)resolveInstanceMethod:(SEL)sel
{
    if (sel == @selector(eat:)) {
        class_addMethod(self, sel, (IMP)Ceat, "v@:I");
        return YES;
    }
    return [super resolveInstanceMethod:sel];
}
void Ceat(id self, SEL cmd, NSInteger num) {
    NSLog(@"void Ceat(id self, SEL cmd, int num):");
    NSLog(@"%@, %s, %ld", [self class], sel_getName(cmd), num);
}

@end

///main.m
#import <Foundation/Foundation.h>
#import "Student.h"
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        NSLog(@"Hello, World!");
        Student *student = [[Student alloc] init];
        [student eat:@"123"];
    }
    return 0;
}

// messageTransmit[1221:273136] void Ceat(id self, SEL cmd, int num):
//messageTransmit[1221:273136] Person, eat:, 123
```
- éœ€è¦å¯¼å…¥runtimeå¤´æ–‡ä»¶ä»¥ä½¿ç”¨æŸäº›æ–¹æ³•
- "v@:I"ä¸­å¯¹åº”å…³ç³»ä¸º
  - v : void
  - @ : eat 
  - : : sel
  - I : NSInteger
- å¦‚æœä¸ç†è§£è¿™ä¸ªç±»å‹ç¼–ç ï¼Œè¯·çœ‹æˆ‘ä¸Šç¯‡æ–‡ç« 

### åŠ å¤§éš¾åº¦
- å‡å¦‚æˆ‘ä»¬å»ºä¸€ä¸ªstudentç±»ç»§æ‰¿äºPersonï¼Œç»™studentä¹Ÿç”³æ˜ä¸ªä¸å­˜åœ¨çš„eat:æ–¹æ³•ï¼Œè°ƒç”¨ä¸€æ³¢
- ç»“æœä¾ç„¶ä¼šèµ°Ceatå‡½æ•°
- è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºç»§æ‰¿æœ¬æ¥å°±ä¼šèµ°çˆ¶ç±»é‡Œå®ç°çš„æ–¹æ³•ğŸ˜‚

### æ•´ç†æ³¢æ€è·¯
- æ‰€ä»¥è¿™ä¸ªæ–¹æ³•è°ƒç”¨çš„æµç¨‹é™¤äº†ä¹‹å‰æ•´ç†çš„cacheç¼“å­˜ï¼Œmethodæ–¹æ³•åˆ—è¡¨ï¼Œä¹‹ååˆå¤šäº†è½¬å‘è¿™ä¸€ç¯èŠ‚
- è½¬å‘ä¸€å®šæ˜¯åœ¨ä¸Šé¢è¿™äº›æµç¨‹å®Œäº†ä¹‹åæ‰ä¼šè¿›å…¥çš„
- å†åŠ ä¸Šç»§æ‰¿çˆ¶ç±»è¿™ä¸€å±‚ï¼Œå¤ªç¥ç§˜äº†å‘€

# å¤‡ç”¨æ¥å—è€…ã€(id)forwardingTargetForSelector:(SEL)aSelectorã€‘

## ä½œç”¨

- æŒ‡å®šæŸä¸ªç±»å»ä»£æ›¿æ‰§è¡Œè¯¥æ–¹æ³•
- è¿™ä¸ªç±»è¢«ç§°ä¸ºå¤‡ç”¨æ¥å—è€…ã€å®ƒå¾—æœ‰è¿™ä¸ªæ–¹æ³•ã€‘

## runtimeæºç 

```objective-c
- (id)forwardingTargetForSelector:(SEL)sel {
    return nil;
}
```

- åŒæ ·é»˜è®¤æ˜¯ä¸æ‰“å¼€ï¼Œç›´æ¥è¿”å›nil

## æ­£å¸¸ä½¿ç”¨

-  æ–°å»ºTeacherç±»ï¼ŒåŒæ ·ç»§æ‰¿äºPerson

```objective-c
- (id)forwardingTargetForSelector:(SEL)aSelector {
    NSString *selStr = NSStringFromSelector(aSelector);
    
    if ([selStr isEqualToString:@"eat:"]) {
        return [[Student alloc] init];
    }
    
    return [super forwardingTargetForSelector:aSelector];
}

//Student:eat:(NSString *)str:123
```

- è¿™æ ·çš„å§”æ‰˜åŒæ ·æ˜¯éµå¾ªæˆ‘ä»¬è¿™ä¸ªæ–¹æ³•è°ƒç”¨æµç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœPersonç±»é‡Œå†è½¬å‘ï¼Œä¾ç„¶èƒ½è½¬å‘å‡ºå»

## æ„ä¹‰

- è¿™ä¸ªç‰¹æ€§å¾ˆå®¹æ˜“è®©äººäº§ç”Ÿè”æƒ³ï¼Œæ¯•ç«Ÿè¿™æ ·çš„å§”æ‰˜æ‰§è¡Œï¼Œå¾ˆæƒ³å­ç±»æ— æ³•æ‰§è¡Œï¼Œäº¤ç»™çˆ¶ç±»å»æ‰§è¡Œ
- å…¶å®æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•å®ç°ç±»ä¼¼äºå¤šé‡ç»§æ‰¿çš„æ•ˆæœ

# å®Œæ•´è½¬å‘ã€(void)forwardInvocation:(NSInvocation )anInvocationã€‘

- å®Œæ•´è½¬å‘è¦æ¯”å‰ä¸¤ä¸ªå¤æ‚ä¸€äº›
- å› ä¸ºå…¶ä¸­æ¶‰åŠåˆ°äº†å‡ ä¸ªæ²¡æœ‰äº†è§£è¿‡çš„æ¦‚å¿µï¼Œè¿™äº›æ¦‚å¿µç½‘ä¸Šä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å¥½çš„è®²è§£ï¼Œæ‰€ä»¥æˆ‘ä¸»è¦æ˜¯ç¿»è¯‘ä¸‹Appleå®˜æ–¹æ–‡æ¡£é‡Œçš„è§£é‡Š
- ä¸ä¼šçº ç»“å®ƒçš„åº•å±‚æ—¶æ€ä¹ˆå®ç°çš„ï¼Œä½†éœ€è¦çŸ¥é“ä»–ä»¬èµ·äº†ä»€ä¹ˆä½œç”¨

## runtimeæºç 

```objective-c
// Replaced by CF (returns an NSMethodSignature)
- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel {
    _objc_fatal("-[NSObject methodSignatureForSelector:] "
                "not available without CoreFoundation");
}

- (void)forwardInvocation:(NSInvocation *)invocation {
    [self doesNotRecognizeSelector:(invocation ? [invocation selector] : 0)];
}

// Replaced by CF (throws an NSException)
- (void)doesNotRecognizeSelector:(SEL)sel {
    _objc_fatal("-[%s %s]: unrecognized selector sent to instance %p", 
                object_getClassName(self), sel_getName(sel), self);
}
```

- è¿™é‡Œæ³¨æ„ï¼Œå®Œæ•´è½¬å‘ä½œä¸ºæœ€åä¸€é¡¹ä¿æŠ¤æ‰‹æ®µï¼ŒforwardInvocationæ–¹æ³•å¦‚æœä¸è¢«é‡å†™ï¼Œå°±ä¼šæ‰§è¡ŒdoesNotRecognizeSelectorï¼Œä¹Ÿå°±æ˜¯æŠ›å‡ºäº†å¼‚å¸¸

## æ¦‚å¿µè§£é‡Š

### NSMethodSignature

#### Appleæ–‡æ¡£

A record of the type information for the return value and parameters of a method.

Use an `NSMethodSignature` object to forward messages that the receiving object does not respond toâ€”most notably in the case of distributed objects. You typically create an `NSMethodSignature`object using the [`NSObject`](apple-reference-documentation://hcttKQiP8Q) [`methodSignatureForSelector:`](apple-reference-documentation://hcqqt_hq1l)instance method (in macOS 10.5 and later you can also use [`signatureWithObjCTypes:`](apple-reference-documentation://hc5Ht0yIa0)). It is then used to create an [`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) object, which is passed as the argument to a [`forwardInvocation:`](apple-reference-documentation://hcR2PGYTDL) message to send the invocation on to whatever other object can handle the message. In the default case, [`NSObject`](apple-reference-documentation://hcttKQiP8Q) invokes [`doesNotRecognizeSelector:`](apple-reference-documentation://hcUsWRgbKL), which raises an exception. For distributed objects, the [`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) object is encoded using the information in the `NSMethodSignature` object and sent to the real object represented by the receiver of the message.



æ–¹æ³•çš„è¿”å›å€¼ä»¥åŠå‚æ•°çš„ç±»å‹ä¿¡æ¯çš„è®°å½•

ä½¿ç”¨ä¸€ä¸ª`NSMethodSignature`å¯¹è±¡æ¥è½¬å‘é‚£äº›æ¥å—è€…æ— æ³•å“åº”çš„æ¶ˆæ¯ï¼Œå°¤å…¶æ˜¯åœ¨`distributed`å¯¹è±¡çš„æƒ…å†µä¸‹ã€‚é€šå¸¸ä½¿ç”¨[`methodSignatureForSelector:`](apple-reference-documentation://hcqqt_hq1l)æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª`NSMethodSignature`å¯¹è±¡ã€‚è¯¥å¯¹è±¡ä¹‹åä¼šè¢«ç”¨ä½œåˆ›å»ºä¸€ä¸ª[`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) å¯¹è±¡ã€‚è¿™ä¸ª[`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) å¯¹è±¡å›ä½œä¸ºä¼ ç»™[`forwardInvocation:`](apple-reference-documentation://hcR2PGYTDL) æ–¹æ³•çš„å‚æ•°ã€‚è¿™æ ·å­é‚£äº›æ— æ³•å“åº”çš„æ¶ˆæ¯ä¼šè¢«å‘ç»™[`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) å¯¹è±¡ï¼Œè½¬å‘ç»™ä»»æ„èƒ½å¤„ç†è¿™ä¸ªæ¶ˆæ¯çš„å¯¹è±¡ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡æ˜¯ä¼šç›´æ¥è°ƒç”¨[`doesNotRecognizeSelector:`](apple-reference-documentation://hcUsWRgbKL)æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ã€‚å¯¹äº`distributed`å¯¹è±¡ï¼Œ[`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) å¯¹è±¡æ ¹æ®åœ¨`NSMethodSignature`å¯¹è±¡ä¸­çš„ä¿¡æ¯è¢«ç¼–ç å‘ç»™çœŸæ­£çš„æ‰§è¡Œå¯¹è±¡ä»£æ›¿æ¶ˆæ¯çš„æ¥å—è€…ã€åŸå¯¹è±¡ã€‘

#### è§£é‡Š

- è¿™æ®µå®åœ¨æœ‰ç‚¹æŠ½è±¡çš„
- æˆ‘çš„ç†è§£å°±æ˜¯å…ˆå°†æ— æ³•è¢«å“åº”çš„æ–¹æ³•å°è£…åˆ°`NSMethodSignature`å¯¹è±¡ï¼Œå†æ ¹æ®`NSMethodSignature`å¯¹è±¡å»åˆ›å»º[`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) å¯¹è±¡ï¼Œä½œä¸º[`forwardInvocation:`](apple-reference-documentation://hcR2PGYTDL) æ–¹æ³•çš„å‚æ•°ï¼Œè¿›è¡Œè½¬å‘
- ä¹Ÿå°±æ˜¯è¯´[`NSInvocation`](apple-reference-documentation://hcjVj4h-wP) å°±ç±»ä¼¼äºä¸€ä¸ªä¸­è½¬ç«™ï¼Œè¿›è¡Œå„è·¯è½¬å‘

### NSInvocation
#### Appleæ–‡æ¡£

An Objective-C message rendered as an object.

å‘ˆç°ä¸€ä¸ªå¯¹è±¡çš„Objective-Cä¿¡æ¯

`NSInvocation` objects are used to store and forward messages between objects and between applications, primarily by [`NSTimer`](apple-reference-documentation://hcaODPrPmP)objects and the distributed objects system. An `NSInvocation` object contains all the elements of an Objective-C message: a target, a selector, arguments, and the return value. Each of these elements can be set directly, and the return value is set automatically when the `NSInvocation` object is dispatched.

`NSInvocation` å¯¹è±¡æ—¶ç”¨äºåœ¨å¯¹è±¡ä»¥åŠAPPä¹‹é—´è½¬å‘ä¿¡æ¯è€Œå­˜åœ¨çš„ï¼Œä¸»è¦é€šè¿‡NSTimerå¯¹è±¡å’Œdistributed objects systemã€‚ä¸€ä¸ª`NSInvocation` å¯¹è±¡åŒ…å«OCæ¶ˆæ¯ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼ša target, a selector, å‚æ•°, å’Œè¿”å›å€¼ã€‚ æ¯ä¸€éƒ¨åˆ†éƒ½èƒ½è¢«ç›´æ¥è®¾ç½®ï¼Œå¹¶ä¸”åœ¨`NSInvocation` å¯¹è±¡è¢«å‘é€æ—¶è‡ªåŠ¨è®¾ç½®

An `NSInvocation` object can be repeatedly dispatched to different targets; its arguments can be modified between dispatch for varying results; even its selector can be changed to another with the same method signature (argument and return types). This flexibility makes `NSInvocation` useful for repeating messages with many arguments and variations; rather than retyping a slightly different expression for each message, you modify the `NSInvocation` object as needed each time before dispatching it to a new target.

ä¸€ä¸ª`NSInvocation` å¯¹è±¡å¯ä»¥è¢«é‡å¤å‘é€åˆ°ä¸åŒçš„targetï¼Œå®ƒçš„å‚æ•°å¯ä»¥åœ¨ä¸ºäº†æ”¹å˜ç»“æœè€Œè¿›è¡Œçš„å‘é€ä¹‹é—´è¢«ä¿®æ”¹ã€‚ç”šè‡³å®ƒçš„selectorå¯ä»¥å˜æˆå¦ä¸€ä¸ªæœ‰ç€ç›¸åŒçš„æ–¹æ³•ç­¾åã€å‚æ•°ä»¥åŠè¿”å›å€¼ã€‘ã€‚è¿™ç§çµæ´»æ€§ä½¿å¾—`NSInvocation` å¯¹äºé‡å¤å‘é€æœ‰ç€è®¸å¤šå‚æ•°å’Œå˜åŒ–çš„æ¶ˆæ¯å¤§æœ‰ç›Šå¤„ã€‚è€Œä¸å†éœ€è¦ä¸ºæ¯ä¸€ä¸ªæ¶ˆæ¯çš„ä¸åŒï¼Œè€Œå»ä¿®æ”¹çš„å®ƒçš„è¡¨è¾¾ï¼Œä½ åªéœ€åœ¨æ¯æ¬¡å‘é€ç»™æ–°çš„targetå‰ä¿®æ”¹è¿™ä¸ª `NSInvocation` å¯¹è±¡ã€æœ‰éœ€è¦çš„è¯ã€‘

#### è§£é‡Š

- è¶Šæ¥è¶ŠæŠ½è±¡äº†ğŸ˜¢
- `NSInvocation`é‡Œä¹°å‘¢ä¼šçœŸæ­£å°è£…æ¶ˆæ¯æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼Œåœ¨è½¬å‘æ—¶ï¼Œä¼šå°†æ•´ä¸ª`NSInvocation`å¯¹è±¡å‘é€ç»™æ–°çš„target

## æ­£å¸¸ä½¿ç”¨
 ```objective-c
// Person.m

//æˆ‘ä»¬å¿…é¡»é‡å†™è¯¥æ–¹æ³• æ¶ˆæ¯è½¬å‘æœºåˆ¶ä½¿ç”¨ä»è¿™ä¸ªæ–¹æ³•ä¸­è·å–çš„ä¿¡æ¯æ¥åˆ›å»ºNSInvocationå¯¹è±¡ã€‚å› æ­¤æˆ‘ä»¬å¿…é¡»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œä¸ºç»™å®šçš„selectoræä¾›ä¸€ä¸ªåˆé€‚çš„æ–¹æ³•ç­¾åã€‚
- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector
{
     NSString *sel = NSStringFromSelector(aSelector);
    // åˆ¤æ–­è¦è½¬å‘çš„SEL
    if ([sel isEqualToString:@"sleep"]) {
        // ä¸ºè½¬å‘çš„æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆç­¾å
        return [NSMethodSignature signatureWithObjCTypes:"v@:"];
        //é‚£ä¹ˆNSMethodSignatureåˆæ˜¯ä»€ä¹ˆï¼Ÿæ¥çœ‹çœ‹
    }
    
    return [super methodSignatureForSelector:aSelector]; 
}

//NSObjectçš„forwardInvocation:æ–¹æ³•å®ç°åªæ˜¯ç®€å•è°ƒç”¨äº†doesNotRecognizeSelector:æ–¹æ³•ï¼Œå®ƒä¸ä¼šè½¬å‘ä»»ä½•æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œå¦‚æœä¸åœ¨ä»¥ä¸Šæ‰€è¿°çš„ä¸‰ä¸ªæ­¥éª¤ä¸­å¤„ç†æœªçŸ¥æ¶ˆæ¯ï¼Œåˆ™ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ã€‚
//è½¬å‘æ¶ˆæ¯
- (void)forwardInvocation:(NSInvocation *)anInvocation
{
    //æ‹¿åˆ°æ¶ˆæ¯
    SEL selector = [anInvocation selector];
    // æ–°å»ºéœ€è¦è½¬å‘æ¶ˆæ¯çš„å¯¹è±¡ è½¬å‘æ¶ˆæ¯
    Child *child = [[Child alloc] init];
    if ([child respondsToSelector:selector]) {
        // è½¬å‘ å”¤é†’è¿™ä¸ªæ–¹æ³•
        [anInvocation invokeWithTarget:child];
    } else {
        [super forwardInvocation:anInvocation];
    }
}
//ä»æŸç§æ„ä¹‰ä¸Šæ¥è®²ï¼ŒforwardInvocation:å°±åƒä¸€ä¸ªæœªçŸ¥æ¶ˆæ¯çš„åˆ†å‘ä¸­å¿ƒï¼Œå°†è¿™äº›æœªçŸ¥çš„æ¶ˆæ¯è½¬å‘ç»™å…¶å®ƒå¯¹è±¡ã€‚æˆ–è€…ä¹Ÿå¯ä»¥åƒä¸€ä¸ªè¿è¾“ç«™ä¸€æ ·å°†æ‰€æœ‰æœªçŸ¥æ¶ˆæ¯éƒ½å‘é€ç»™åŒä¸€ä¸ªæ¥æ”¶å¯¹è±¡ã€‚è¿™å–å†³äºå…·ä½“çš„å®ç°ã€‚
 ```

## ç–‘æƒ‘

- è¿™é‡Œæ¯”è¾ƒè¿·äººçš„å°±æ˜¯ä¸ºä»€ä¹ˆNSMethodSignatureå¯¹è±¡åªéœ€è¦æ–¹æ³•ç­¾åå°±å¯ä»¥ç”Ÿæˆäº†ï¼Œå…¶ä½™çš„å‚æ•°åˆæ˜¯ä»€ä¹ˆæ—¶å€™æ·»åŠ åˆ°NSInvocationå¯¹è±¡é‡Œå»çš„

# æ¶ˆæ¯è½¬å‘çš„æ„ä¹‰

- æ˜¾ç„¶é˜²æ­¢crashè¿™ä¸€ç‚¹ç«™ä¸ä½è„šï¼Œæˆ–è€…è¯´å±äºæ­£ç¡®çš„åºŸè¯ã€‚
- ä¸Šè¿°ä¸‰ä¸ªæ–¹æ³•éƒ½å¾—å»ºç«‹åœ¨å·²ç»çŸ¥é“äº†é‚£ä¸ªæ–¹æ³•æ— æ³•æ‰§è¡Œï¼Œå¾—åœ¨çŸ¥é“äº†å…¶selä¹‹åæ‰èƒ½ç”¨ï¼Œå‡å¦‚æˆ‘å·²ç»çŸ¥é“å“ªä¸ªæ–¹æ³•ï¼Œæˆ‘ç›´æ¥è¡¥ä¸Šå°±è¡Œäº†ï¼Œä½•å¿…è¦è½¬å‘å‘¢ï¼Ÿ
- å› æ­¤æˆ‘ä»¬ä½¿ç”¨æ¶ˆæ¯è½¬å‘æ›´å¤šè¿˜æ˜¯æƒ³å®ç°æŸäº›éªšæ“ä½œï¼Œæˆ–è€…è¯´Black Magicï¼
- è¿™æ–¹é¢ç”±äºç¬”è€…é’»ç ”ä¸å¤ªæ·±ï¼Œè´´ä¸€ç¯‡æ„Ÿè§‰æ¯”è¾ƒå¥½çš„æ–‡ç« 
- [iOSä¸­æ¶ˆæ¯è½¬å‘æœºåˆ¶åŠå·¥ç¨‹åº”ç”¨](https://blog.csdn.net/cewei711/article/details/53189620)