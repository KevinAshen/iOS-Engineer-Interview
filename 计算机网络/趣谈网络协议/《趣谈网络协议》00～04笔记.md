[TOC]

# 关于我的仓库

- 这篇文章是我为面试准备的学习总结中的一篇
- 我将准备面试中找到的所有学习资料，写的Demo，写的博客都放在了这个仓库里[iOS-Engineer-Interview](https://github.com/KevinAshen/iOS-Engineer-Interview)
- 欢迎star👏👏
- 其中的博客在简书，CSDN都有发布
- 博客中提到的相关的代码Demo可以在仓库里相应的文件夹里找到

# 前言

- 该系列为学习《趣谈网络协议》的系列学习笔记
- 总结内容包括其中的重要知识概念，以及课后题的解答
- 计算机网络的协议不仅是为了能作为进入大厂的敲门砖，也是希望能抓到计算机世界不变的本质，希望能在计算机领域努力下去
- 与同步学习的网课《数据结构与算法之美》不同，计算机网络明显抽象，之前的接触基本为0【只有大一学习计算机导论的时候会涉及部分】，也不是很能明白其中的知识点之类的，只能说希望在学习过程中多摸索吧！
- 由于欠缺的基础知识比较多，系列文章不会只涉及网课，该补充的知识还是得放上去
- 多说无益，你应该开始学了

# 00讲想成为技术牛人?先搞定网络协议!

- 开讲词跟多的是涉及讲课的内容与方式，学习摘录的点不多
- 很多情况下，只要搞定了网络，一个大型系统也就搞定了一半
- 想要不被滚滚而来的新技术淘汰，就要掌握这些可以长 久使用的知识，而网络协议就是值得你学习，而且是到 40 岁之后依然有价值的知识。
- 困难：
  - 网络协议知识点太多，学完容易忘
  - 看上去懂了，经不住问
  - 知识点学会了，实际运用依然不会
- 金句：看上去最是枯燥，最基础的东西往往具有最长久的生命力

# 01讲为什么要学习网络协议？
## 引入：什么是协议？

- 这里以编译器“翻译”编程语言举例，以OC举例：

 ```objective-c
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        // insert code here...
        NSLog(@"Hello, World!");
    }
    return 0;
}
 ```

- 这里我们希望在控制台中打印出“Hello, World”，我们使用OC或者其他的高级编程语言就是一种”协议“，这个协议保证的就是让计算机能理解我们的需求，通过协议，计算机才能明白我们希望它们做什么

### 协议三要素

- 由于我们使用的还是高级语言，所以需要编译器给我们进行翻译工作，这里就体现出了协议的三要素
![page2image54362736.png](http://ww3.sinaimg.cn/large/006y8mN6ly1g67fh3dcwqj30pt05174z.jpg) 
- 语法：要遵循的规则与格式【括号要成对，结束要使用分号等】
- 语义：这一段要具备某种意义【数字减去数字是有意义的，数字减去文本一般来说就没有意义。】
- 顺序：先做什么，后做什么【可以先加上某个数值，然后再减去某个数值】
- 协议还有其他的特点：
  - 协议中的每个人都必须了解协议，并且预先知道所要完成的所有的步骤。
  - 协议中的每个人都必须同意并遵循它。
  - 协议必须是清楚的，每一步必须明确定义，并且不会引起误解。
- 另外，虽然老师举了编译器中国例子，但现在通行的理解会直接把协议就默认为网络协议

### 协议例子
- 网易考拉的例子：

```html
HTTP/1.1 200 OK
Date: Tue, 27 Mar 2018 16:50:26 GMTContent-Type: text/html;charset=UTF-8
Content-Language: zh-CN

<!DOCTYPE html>
<html>
<head>
<base href="https://pages.kaola.com/" />
<meta charset="utf-8"/> <title> 网易考拉 3 周年主会场 </title>
```

- 语法：符合语法，也就是说，只有按照上面那个格式来，浏览器才认。例如，上来是**状态**，然后是**首部**，然后是**内容**。【这里稍微有点web开发小基础就能明白三块分别是什么，哪怕是我这种天天翘课的水平😝】
- 语义：符合语义，就是要按照约定的意思来。例如，状态 200，表述的意思是网页成功返回。如果不成功，就是我们常见的“404”。【就是第一行中的200】
- 顺序：符合顺序，你一点浏览器，就是发送出一个 HTTP 请求，然后才有上面那一串 HTTP 返回的东西。

## 【准备掉头发吧！】以一个在电商网站上下单的过程初识有哪些常用网络协议

- 学00讲的时候还很快乐，觉得学这个很有用，blbl雄心壮志，结果01讲这个神仙例子就把我整懵了，乃至学完这节后每次点击链接都会想下其中有那么复杂的流程。。。还我上网体验！🌚
- 由于还在学习前期，其实对于这个例子涉及到的东西有些还是不太理解，如果有大神看到这篇文章，愿意指出错误，不胜感激！
- 唉，多说无益，开整吧！

### 目标IP地址

- 我们在输入框中输入的只是URL网址：https://www.kaola.com
- 现在我们的浏览器只知道名字是“www.kaola.com”，并不知道具体的地点，此时，我们需要获取到目标IP地址
- 这里有两种方式：
  - 一般的地址簿协议DNS
  - 更加精确的地址簿查找协议HTTPDNS
- 无论使用什么方式，最后都会获取到106.114.138.24这个地址【没明白，这个IP地址好像没什么特别的。。。】
- 而IP就是互联网世界的门牌号
- 下面就要开始打包请求，进入传输层

#### 补充知识：URL

- url是统一资源定位符，对可以从互联网上得到的资源的位置和访问方法的一种简洁的表示，是互联网上标准资源的地址。互联网上的每个文件都有一个唯一的URL，它包含的信息指出文件的位置以及浏览器应该怎么处理它。url 是网民们在 Internet 知识海洋中寻找资源、获取信息、用 E- mail 通讯、网上交流等所必不可少的。
- 基本URL包含模式（或称协议）、服务器名称（或IP地址）、路径和文件名，如“协议：//授权/路径查询”。完整的、带有授权部分的普通统一资源标志符语法看上去如下：协议：//用户名:密码@子域名.域名.顶级域名:端口号/目录/文件名.文件后缀参数=值#标志。
- 第一部分：模式/协议（scheme）：它告诉浏览器如何处理将要打开的文件。最常用的模式是超文本传输协议（Hypertext Transfer Protocol，缩写为HTTP），这个协议可以用来访问网络
- 第二部分：第二部分是 Internet 主机名。我们希望访问的 WWW 页 面就存放在该计算机上。有了这台计算机的名 字，Internet 通过 DNS( 域名服务器) 找到与这台计算机的英文名相对应的数字地址，也叫做 IP 地址，就能够在全世界范围内找到这台计算机，不管它是在哪个国家或哪个地区。 文件所在的服务器的名称或IP地址，后面是到达这个文件的路径和文件本身的名称。服务器的名称或IP地址后面有时还跟一个冒号和一个端口号。它也可以包含接触服务器必须的用户名称和密码。
- 第三部分：url的第三项为路径。它定义信息保存在 这台计算机上的什么地方，即哪个子目录中。 每个子目录的前面有 一条斜杠 。路径部分包含等级结构的路径定义，一般来说不同部分之间以斜线（/）分隔。询问部分一般用来传送对服务器上的数据库进行动态询问时所需要的参数。 
- 第四部分：url的第四项是文件名或主页名。也就是我们想要访问的某个具体信息的文件名或主页名。在 http://home.netscape.com/pub/ma in/index.html 中 index.html 为主页名。当然，文件名也是可以省略的，如果省略，你所连接的计算机将自动决定使用哪一个文件。常见的 文件类型有：正式的 Web 页( .html) 、纯文本文件( .txt 或.text) 、图片文件( .gif 或.jpeg) 、声音文件( .wav 或.au) 、电 影文件( .avi 或.mpeg) 等。 
- 上面👆这些内容来自百度百科，我们根据我们这个例子来看看每个部分是什么
- 我们这个例子就两部分，http是协议，www.wangyikaola.com就是域名，也就是第二部分里面的主机名，我们根据它来获取到唯一的IP地址
- 参考：[快速搞懂URL的构成](https://www.jianshu.com/p/406d19dfabd3)

### 应用层

- 这里注意，虽然我把查找IP地址部分放在了应用层上面，但是DNS协议也是应用层的协议，换句话说上面这部分也是应用层的操作
- 我们在知道目标地址后，会开始打包请求，对于一般的请求，使用http；由于购物中往往需要加密传输，我们使用HTTPS协议
- 我们会在这一层写清楚“我要买什么，买多少”【用户输入的内容】
- 这里捋一捋，我们现在知道目标IP地址，目标URL，以及我们的内容

![page4image54377712.png](http://ww3.sinaimg.cn/large/006y8mN6ly1g67j2qfan2j30dl04tq38.jpg) 

- DNS、HTTP、HTTPS 所在的层我们称为**应用层**。经过应用层封装后，浏览器会将应用层 的包交给下一层去完成，通过 socket 编程来实现。下一层是**传输层**。

#### 补充知识：http与https

- http：HyperText Transfer Protocol，超文本传输协议
  - http的中文叫做超文本传输协议,它负责完成客户端到服务端的一系列操作,是专门用来传输注入HTML的超媒体文档等web内容的协议,它是基于传输层的TCP协议的应用层协议
  - HTTP是一个简单的请求-响应协议，它通常运行在TCP之上。它指定了客户端可能发送给服务器什么样的消息以及得到什么样的响应。请求和响应消息的头以ASCII码形式给出；而消息内容则具有一个类似MIME的格式。这个简单模型是早期Web成功的有功之臣，因为它使得开发和部署是那么的直截了当。 
- https：Hyper Text Transfer Protocol over Secure Socket Layer 或 Hypertext Transfer Protocol Secure，超文本传输安全协议
  - https是基于安全套接字的http协议,也可以理解为是http+ssl/tls(数字证书)的组合
  - 是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。 它是一个URI scheme（抽象标识符体系），句法类同http:体系。用于安全的HTTP数据传输。
- 区别：
  - HTTP 的 URL 以 http:// 开头，而 HTTPS 的 URL 以 https:// 开头
  
  - HTTP 是不安全的，而 HTTPS 是安全的
  
  - HTTP 标准端口是 80 ，而 HTTPS 的标准端口是 443
  
  - 在 OSI 网络模型中，HTTPS的加密是在传输层完成的,因为SSL是位于传输层的,TLS的前身是SSL,所以同理
  
  - HTTP无需认证证书,而https需要认证证书
  
  - 简单来说http是用来进行html等超媒体传输的,但是http不安全,为了安全,使用证书SSL和HTTP的方式进行数据传输,也就是HTTPS 
- 参考：[HTTP和HTTPS的区别和常见的面试题](https://blog.csdn.net/zhttly/article/details/82895713)

### 传输层

- 传输层有两种协议， 一种是无连接的协议UDP，一种是面向连接的协议TCP。对于支付来讲，往往使用 TCP协议。所谓的面向连接就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。【UDP有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。】
- UDP没有被完全淘汰，但既然http都是基于TCP的应用层协议，这个UDP，emm。。。

- TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是电商的服务器监听的端 口。操作系统往往通过端口来判断，它得到的包应该给哪个进程。【顶不住了，怎么突然开始操作系统，线程了😿】

![page5image54368560.png](http://ww4.sinaimg.cn/large/006y8mN6ly1g67jj9zbxkj30dl060gm7.jpg)

- ？？？：这里的端口指的是总结电脑上的东西，我们在浏览器上下单，这个电商应用端口是个啥子东西

#### 补充知识：端口

- "端口"是英文port的意译，可以认为是设备与外界通讯交流的出口。
- 端口是指接口电路中的一些寄存器，这些寄存器分别用来存放数据信息、控制信息和状态信息，相应的端口分别称为数据端口、控制端口和状态端口。
电脑运行的系统程序，其实就像一个闭合的圆圈，但是电脑是为人服务的，他需要接受一些指令，并且要按照指令调整系统功能来工作，于是系统程序设计者，就把这个圆圈截成好多段，这些线段接口就叫端口（通俗讲是断口，就是中断），系统运行到这些端口时，一看端口是否打开或关闭，如果关闭，就是绳子接通了，系统往下运行，如果端口是打开的，系统就得到命令，有外部数据输入，接受外部数据并执行。
- TCP端口：TCP端口就是为TCP协议通信提供服务的端口。TCP （Transmission Control Protocol） ，TCP是一种面向连接（连接导向）的、可靠的、基于字节流的运输层（Transport layer）通信协议，由IETF的RFC 793说明（specified）。在计算机网络OSI模型中，它完成第四层传输层所指定的功能。我们的电脑与网络连接的许多应用都是通过TCP端口所实现的。

### 网络层【计算机网络露出了狰狞的笑容】

- 这里我们会看到目前为止，我们还是在自己电脑上折腾，还没有走出去，而网络层就会真正带我们进行传输
- 网络层相关的协议就是我们最开始就提到的根据域名获取到的IP协议。
- 在 IP 协议里面会有源 IP 地址，即浏览器所在机器的 IP 地址和目标 IP 地址，也即电商网站所在 服务器的 IP 地址。

![page5image54375840.png](http://ww4.sinaimg.cn/large/006y8mN6ly1g67jva59ipj30dl079gmk.jpg) 

- 现在我们知道了目标IP地址，需要根据它到达目标机器
- 但由于我们是要与远方的机器进行交互，要出国，所以我们首先要到网关
- 操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1。【后面会学到】
- 192.168.1.1属于IP地址的C类地址，属于保留IP，专门用于路由器设置
- 现在我们有本地的IP地址，有网关的IP地址，现在要将目标IP地址发给网关，此时会通过ARP协议【链路层】将本机的MAC地址，网关的MAC地址一起打包发给网关【夭寿了，MAC即是电脑又是口红还是地址】
- 又网关给我们进行转发，带我们找到目标
- 这里涉及到的链路层貌似只是为了获取下MAC地址，取出MAC地址接下来还是网络层方面的传输【可能理解不太对】
#### 补充知识：MAC地址
- MAC地址（英语：Media Access Control Address），直译为媒体存取控制位址，也称为局域网地址（LAN Address），MAC位址，以太网地址（Ethernet Address）或物理地址（Physical Address），它是一个用来确认网络设备位置的位址。在OSI模型中，第三层网络层负责IP地址，第二层数据链路层则负责MAC位址。MAC地址用于在网络中唯一标示一个网卡，一台设备若有一或多个网卡，则每个网卡都需要并会有一个唯一的MAC地址 。
- 每个网卡都会有个唯一的MAC标识符，刘超老师在后面会有更精彩的比喻讲解

### 下面是一段刘超老师的神奇比喻

- 网关收到包之后，会根据自己的知识，判断下一步应该怎么走。网关往往是一个路由器，到 某个 IP 地址应该怎么走，这个叫作路由表。
- 路由器有点像玄奘西行路过的一个个国家的一个个城关。每个城关都连着两个国家，每个国家相当于一个局域网，在每个国家内部，都可以使用本地的地址 MAC 进行通信。
- 这里需要一波理解：路由器是城关，国家是一个局域网，在局域网的内部可以直接使用MAC地址通信【就像上面我们使用本机的MAC地址向网关发送我们的包】
- 路由表：在计算机网络中，路由表（routing table）或称路由择域信息库（RIB, Routing Information Base），是一个存储在路由器或者联网计算机中的电子表格（文件）或类数据库。路由表存储着指向特定网络地址的路径（在有些情况下，还记录有路径的路由度量值）。路由表中含有网络周边的拓扑信息。路由表建立的主要目标是为了实现路由协议和静态路由选择。
- 现在我们到达了下一个路由器【城关】，需要问一下接下来怎么走【在IP头中有记录源IP以及目标IP】

![page6image54505664.png](http://ww4.sinaimg.cn/large/006y8mN6ly1g67l5x211bj30kr05k75j.jpg) 

- 城关往往是知道这些“知识”的，因为城关和临近的城关也会经常沟通。到哪里应该怎么 走，这种沟通的协议称为**路由协议**，常用的有**OSPF**和**BGP**。【网络层】

![page7image54465824.png](http://ww2.sinaimg.cn/large/006y8mN6ly1g67l7nfn3rj30nk0enmy2.jpg) 

- 在到下一个国家还是一样先通过国家里的MAC地址获取到下一个城关的MAC地址【这里就能大概理解到为什么一定要通过MAC地址通信，城关就是路由器，默认的IP地址是一样的，如果不加以区分，显然会出错】
- 当到达目标城关后【进入了目标局域网】，在这里就能根据目标IP获取到目标MAC
- 目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也对上了，就取下 IP 头。IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即**TCP 层**【传输层】。

- 对于传输层，只要收到一个包就会回复一个包说明收到了，这个包里只是TCP层一个说明，说明收到了。这个回复包会根据来时的路走回去报个平安。
- 为什么呢？因为我们使用的面向连接的TCP协议，它如果迟迟收不到回复会重新发送
- 这里需要一波理解：我们在应用层下单，进入传输层，再下到网络层，通过链路层获取MAC地址后，回到网络层，在网络层见通信找到了目标机器，这是一个由上至下的过程；而发送到以后，会先根据MAC地址验证，往上到网络层，验证IP地址，再往上到传输层，发送收到的包。这个整个流程应用层只干一次活，都是TCP埋头苦干，注意⚠️
- 当网络包平安到达 TCP 层之后，TCP 头中有目标端口号，通过这个端口号，可以找到电商 网站的进程正在监听这个端口号，假设一个 Tomcat，将这个包发给电商网站。

![page8image54508160.png](http://ww3.sinaimg.cn/large/006y8mN6ly1g67lmtfemxj310v0qdqdj.jpg) 

- 可以看到，我们的请求一开始只有正文部分，随着一层层往下，添加了各种内容，而发送到以后，随着一层层往上，内容不断被剥除

- 电商网站的进程得到 HTTP 请求的内容，知道了要买东西，买多少。往往一个电商网站最 初接待请求的这个 Tomcat 只是个接待员，负责统筹处理这个请求，而不是所有的事情都 自己做。例如，这个接待员要告诉专门管理订单的进程，登记要买某个商品，买多少，要告 诉管理库存的进程，库存要减少多少，要告诉支付的进程，应该付多少钱，等等。 

- 如何告诉相关的进程呢?往往通过 RPC 调用，即远程过程调用的方式来实现。远程过程调 用就是当告诉管理订单进程的时候，接待员不用关心中间的网络互连问题，会由 RPC 框架 统一处理。RPC 框架有很多种，有基于 HTTP 协议放在 HTTP 的报文里面的，有直接封装 在 TCP 报文里面的。 


- 当接待员发现相应的部门都处理完毕，就回复一个 HTTPS 的包，告知下单成功。这个 HTTPS 的包，会像来的时候一样，经过千难万险到达你的个人电脑，最终进入浏览器，显 示支付成功。 

## 所有涉及到的协议

![page9image54522256.jpg](http://ww2.sinaimg.cn/large/006y8mN6ly1g67n4fo16lj30u20evwjo.jpg) 

## 课后题：当网络包到达一个城关的时候，可以通过路由表得到下一个城关的 IP 地址，直接通过 IP 地 址找就可以了，为什么还要通过本地的 MAC 地址呢?

- mac好比人的身份id，IP好比他的住址，住址可以变，人的身份🆔不会变。
- IP是网络层使用的 mac是链路层使用的 ip包最终还是要通过物理链接和mac地址进行交互的

- 因为mac地址是全世界唯一的，不会找错人!而ip地址会是发生改变的!有可能现在ip地址 A是这里的地址!在下一刻就是B的地址了!
  综上所述:所以要有mac地址!